//
//  GuHomeViewController.swift
//  AtHome
//
//  Created by Gu on 16/4/18.
//  Copyright © 2016年 MengTai. All rights reserved.
//

import UIKit
import SDCycleScrollView
import SwiftyJSON
import Alamofire



class GuHomeViewController: UIViewController,UITableViewDelegate,UITableViewDataSource,UICollectionViewDataSource,UICollectionViewDelegate {
    
    var DataSource = NSMutableArray()
    var CollectionDataSource = NSMutableArray()
    var ThirdData = NSMutableArray()
    var tempID = String()
    
    let transparentPixel = UIImage.imageWithColor(color: UIColor.clear)
    
    override func viewDidLoad() {
        super.viewDidLoad()
        
        //        self.navigationController?.navigationBar.isTranslucent = true;
        //        UINavigationBar.appearance().setBackgroundImage(UIImage(), for: .default)
        
        //        self.navigationController?.navigationBar.barTintColor = UIColor.clear
        
        self.HeaderView.addSubview(ScrollView)
        self.HeaderView.addSubview(MyCollectionView)
        self.HeaderView.addSubview(ThirdView)
        view.backgroundColor = RGB2244546
        view.addSubview(MytableView)
        
        getCellData()
        getScrollView()
    }
    
    //MARK: 懒加载 tableView SDCycleScrollView
    lazy var HeaderView:UIView = {
        let MyHeaderView = UIView.init(frame: CGRect.init(x: 0, y: 0, width: ScreenWidth, height:  200+160+15+135+15))
        MyHeaderView.backgroundColor = RGBBackgroud
        return MyHeaderView
    }()
    
    lazy var MytableView: UITableView = {
        let tableView = UITableView.init(frame: CGRect.init(x: 0, y:0, width: ScreenWidth, height: ScreenHeight))
        tableView.contentInset = UIEdgeInsetsMake(-64, 0, 0, 0)
        tableView.delegate = self
        tableView.dataSource = self
        tableView.register(UINib.init(nibName: "GuPreferentialTableViewCell", bundle: nil), forCellReuseIdentifier: "GuPreferentialTableViewCell")
        tableView.register(UITableViewCell.self, forCellReuseIdentifier: "cell")
        tableView.separatorColor = RGBlineColor
        tableView.estimatedRowHeight = 170;
        tableView.tableFooterView = UIView()
        tableView.translatesAutoresizingMaskIntoConstraints = false;
        tableView.tableHeaderView = self.HeaderView
        return tableView
    }()
    
    lazy var ScrollView:SDCycleScrollView = {
        let  view = SDCycleScrollView.init()
        view.currentPageDotColor = UIColor.red
        view.pageDotColor = UIColor.white
        view.frame = CGRect.init(x: 0, y: 0, width:ScreenWidth , height: 200)
        return view
    }()
    
    lazy var MyCollectionView: UICollectionView = {
        var flowLayout: UICollectionViewFlowLayout = UICollectionViewFlowLayout()
        flowLayout.minimumLineSpacing = 0
        //行距
        flowLayout.minimumInteritemSpacing = 0
        //列距
        flowLayout.itemSize = CGSize.init(width: ScreenWidth/5, height:  80);
        let CollectionView = UICollectionView.init(frame: CGRect.init(x: 0, y: 200, width: ScreenWidth, height: 160), collectionViewLayout: flowLayout)
        CollectionView.backgroundColor = UIColor.white
        CollectionView.register(UINib.init(nibName: "GuHomeCollectionViewCell", bundle: nil), forCellWithReuseIdentifier: "GuHomeCollectionViewCell")
        CollectionView.dataSource = self;
        CollectionView.delegate = self
        
        
        return CollectionView
    }()
    
    lazy var ThirdView: GuThirdView = {
        
        let thirdView = GuThirdView.init(frame: CGRect.init(x: 0, y:ViewH(view: self.MyCollectionView)+ViewY(view: self.MyCollectionView) + 15 , width: ScreenWidth, height: 135))
        
        thirdView.blockC = {(_ detailData:List) in
            
            let data = detailData
            self.detaiList(dataL: data)
        }
        
        
        return thirdView
    }()
    
    lazy var LastCollection: UICollectionView = {
        
        var flowLayout: UICollectionViewFlowLayout = UICollectionViewFlowLayout()
        flowLayout.minimumLineSpacing = 0
        //行距
        flowLayout.minimumInteritemSpacing = 0
        //列距
        flowLayout.itemSize = CGSize.init(width: ScreenWidth/5, height:  80);
        let CollectionView = UICollectionView.init(frame: CGRect.init(x: 0, y: 200, width: ScreenWidth, height: 160), collectionViewLayout: flowLayout)
        CollectionView.backgroundColor = UIColor.white
        CollectionView.register(UINib.init(nibName: "GuHomeCollectionViewCell", bundle: nil), forCellWithReuseIdentifier: "GuHomeCollectionViewCell")
        CollectionView.dataSource = self;
        CollectionView.delegate = self
        return CollectionView
    }()
    
    //MARK: 获取cell数据
    func getData()  {
        Alamofire.request("http://m.adjo2o.com/webproxy/api/adjo2o/adjStore!findByTag.do?pageNum=1&pagesize=10&tagId=1128&cityCode=490").response { (response) in
            let json = JSON.init(data: response.data!)
            let model = findByTagIdData.init(fromJson:json)
            if model.result == 1{
                for data in model.data{
                    
                    self.DataSource.add(data)
                }
                self.MytableView.reloadData()
            }else{return}
        }
    }
    
    
    func getCellData() {
        
        let netWork = GuNetworkTools()
        
        netWork.getRequestData(type: .get, URLString: "adjStore!findByTag.do?pageNum=1&pagesize=10&tagId=1128&cityCode=490") { (response) in
            let model = findByTagIdData.init(fromJson:response as! JSON)
            if model.result == 1{
                for data in model.data{
                    
                    self.DataSource.add(data)
                }
                self.MytableView.reloadData()
            }else{return}
        }
        
    }
    
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        return self.DataSource.count+1
    }
    
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        if indexPath.row == 0 {
            var  Hcell = self.MytableView.dequeueReusableCell(withIdentifier: "cell")
            if   Hcell == nil {
                Hcell = UITableViewCell.init(style:.default, reuseIdentifier: "cell")
                Hcell?.selectionStyle = .none
            }
            Hcell?.selectionStyle = .none
            Hcell?.textLabel?.font = FontNum(Num: 15)
            Hcell?.textLabel?.textColor = RGB505050;
            Hcell?.imageView?.image = UIImage.init(named: "特别推荐icon")
            Hcell?.textLabel?.text = "特别推荐"
            Hcell?.separatorInset = UIEdgeInsets.zero;
            return Hcell!
            
        }
        else{
            var HomeCell = GuPreferentialTableViewCell()
            
            HomeCell = HomeCell.cellWithTableView(tableView: self.MytableView) as! GuPreferentialTableViewCell
            HomeCell.findByTag(model: self.DataSource[indexPath.row-1] as!findByTagId)
            HomeCell.buttonModel = {
                (_ Model:findByTagId?,str:NSString) in
                
                if str.contains("在线选购"){
                    print("***在线选购***"+(Model?.storeName)!+"******")
                }else{
                    print("***优惠买单***"+(Model?.storeName)!+"******")
                }
            }
            return HomeCell
        }
    }
    //
    
    func tableView(_ tableView: UITableView, heightForRowAt indexPath: IndexPath) -> CGFloat {
        if indexPath.row == 0 {
            return 50
        }
        return UITableViewAutomaticDimension
        
    }
    func newPostingBtn(button:UIButton)  {
        
        let num = button.tag;
        let StoreTag:findByTagId  = self.DataSource[num] as!findByTagId
        print(StoreTag.storeName)
    }
    //MARK: 获取轮播图数据+10个功能
    func getScrollView()  {
        let imageURLStrings:NSMutableArray = []
        Alamofire.request("http://m.adjo2o.com/webproxy/api/adjo2o/adjadcComment!adcfindAll.do?appVersion=v00.00.27&cityCode=490&JSESSIONID=D646B3FE2E2920F5C5A784E4453D6477").response { (responseJSON) in
            
            let HeadJson = JSON.init(data: responseJSON.data!)
            let model =  AdsAndClassificationResponse.init(fromJson: HeadJson)
            if model.result == 1{
                for i in 0..<model.data.count{
                    
                    let ads:AdsAndClassification = model.data[i];
                    
                    switch ads.position{
                    case  0:
                        let num = ads.list.count
                        for  i in 0..<num{
                            let obj:List = ads.list[i]
                            let urlStr:String = obj.atturl.replacingOccurrences(of: "fs:", with: picsUrl)
                            imageURLStrings.add(urlStr)
                        }
                        self.ScrollView.imageURLStringsGroup = imageURLStrings as [AnyObject]!
                        
                        break
                    case  1:
                        
                        let num = ads.list.count
                        for  i in 0..<num{
                            let obj:List = ads.list[i]
                            
                            self.CollectionDataSource.add(obj)
                        }
                        self.MyCollectionView.reloadData()
                        break
                    case  2:
                        
                        let num = ads.list.count
                        for  i in 0..<num{
                            let obj:List = ads.list[i]
                            
                            self.ThirdData.add(obj)
                        }
                        
                        self.ThirdView.imageData(array: self.ThirdData)
                        
                        break
                        
                    default: break
                    }
                    
                }
                
                
                let set:CharacterSet = CharacterSet.init(charactersIn: "{}:")
                let array = model.reserve.components(separatedBy: set);
                let ID = array[2]
                self.tempID = ID.replacingOccurrences(of: "\"", with: "")
            }
        }
    }
    
    func numberOfSections(in collectionView: UICollectionView) -> Int {
        return 1
    }
    func collectionView(_ collectionView: UICollectionView, numberOfItemsInSection section: Int) -> Int {
        return self.CollectionDataSource.count
    }
    func collectionView(_ collectionView: UICollectionView, cellForItemAt indexPath: IndexPath) -> UICollectionViewCell {
        var cell:GuHomeCollectionViewCell = GuHomeCollectionViewCell()
        cell = collectionView.dequeueReusableCell(withReuseIdentifier: "GuHomeCollectionViewCell", for: indexPath) as!GuHomeCollectionViewCell
        cell.homecellResult(model: self.CollectionDataSource[indexPath.row] as!List)
        return cell
        
    }
    func collectionView(_ collectionView: UICollectionView, didSelectItemAt indexPath: IndexPath) {
        let data = self.CollectionDataSource[indexPath.row] as? List
        
        self.detaiList(dataL: data!)
    }
    
    func detaiList(dataL:List) -> Void {
        
        
        let URl:String = containStr(obj: dataL)
        
        if URl.contains("List") {
            
            let PreferentialPay = GuPreferentialViewController()
            PreferentialPay.tempID = self.tempID
            PreferentialPay.datasource  = dataL
            self.navigationController?.pushViewController(PreferentialPay, animated: false)
        }
        
        
    }
    
    
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        
        
        // Dispose of any resources that can be recreated.
    }
    
    
    func scrollViewDidScroll(_ scrollView: UIScrollView) {
        
        let offsetY:CGFloat = scrollView.contentOffset.y
        
        drawCustomNavigationBar(offsetY:offsetY)
        
    }
    override func viewDidDisappear(_ animated: Bool) {
        super.viewDidDisappear(animated)
    }
    override func viewWillAppear(_ animated: Bool) {
        super.viewWillAppear(animated)
        
        drawCustomNavigationBar(offsetY:0)
    }
    
    func drawCustomNavigationBar(offsetY:CGFloat) {
        let nav = (self.navigationController?.navigationBar)!
        
        if offsetY > 50{
            
            nav.setBackgroundImage(UIImage.imageWithColor(color: RGB2244546), for: UIBarMetrics.default)
            nav.shadowImage = UIImage.imageWithColor(color: RGB2244546)
            nav.isTranslucent = false
        }else{
            nav.setBackgroundImage(transparentPixel, for: UIBarMetrics.default)
            nav.shadowImage = transparentPixel
            nav.isTranslucent = true
            
        }
        
    }
}

